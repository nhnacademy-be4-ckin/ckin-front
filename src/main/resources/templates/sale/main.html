<!DOCTYPE html>
<html lang="ko"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/default}">

<!-- ë³¸ë¬¸ ë‚´ìš© -->
<div layout:fragment="content">
    <style>

        table {
            text-align: center;
            vertical-align: middle;
        }

        td > input {
            margin-left: 30%;
            margin-top: 10%;
        }

        td > span {
            font-size: 12px;
            color: dodgerblue;
        }
    </style>

    <form action="#" th:action="@{/}" class="bg0 p-t-75 p-b-85">
        <div class="container">
            <div class="row">
                <div class="col-lg-10 col-xl-7 m-lr-auto m-b-50">
                    <div class="m-l-25 m-r--38 m-lr-0-xl">
                        <div class="wrap-table-shopping-cart">
                            <table class="table-shopping-cart" style="text-align: center;">
                                <tr class="table_head">
                                    <th class="column-1"></th>
                                    <th class="column-2">ìƒí’ˆëª…</th>
                                    <th class="column-3">íŒë§¤ê°€</th>
                                    <th class="column-4">ìˆ˜ëŸ‰</th>
                                    <th class="column-5">ì¿ í°</th>
                                    <th class="column-6">ì£¼ë¬¸ê¸ˆì•¡</th>
                                    <th class="column-7">ğŸ í¬ì¥ì§€</th>
                                </tr>

                                <tr class="table_row" th:each="bookSale : ${bookSaleList}">
                                    <td class="column-1">
                                        <div class="how-itemcart1">
                                            <img src="https://kr1-api-object-storage.nhncloudservice.com/v1/AUTH_c20e3b10d61749a2a52346ed0261d79e/bookpub/product/thumbnail/03331c62-d8db-40c8-8f25-2f4160ad8122.png"
                                                 alt="IMG">
                                        </div>
                                    </td>

                                    <td class="column-2" th:text="${bookSale.bookTitle}"></td>
                                    <td class="column-3" th:text="${bookSale.bookSalePrice}">7600 ì›</td>
                                    <td class="column-4">1</td>
                                    <td class="column-5">
                                        <button type="button" id="couponBtn" th:value="${bookSale.bookId}"
                                                class="flex-c-m stext-101 cl2 size-106 bg8 bor13 hov-btn3 p-lr-15 trans-04 pointer m-tb-10"
                                                data-toggle="modal" data-target="#applyCouponBtn">
                                            ì¿ í° ì ìš©
                                        </button>

                                        <!-- Coupon Modal -->
                                        <div class="modal fade" id="applyCouponBtn" tabindex="-1" role="dialog"
                                             aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
                                            <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
                                                <div class="modal-content">
                                                    <div class="modal-header">
                                                        <h5 class="modal-title" id="applyCouponBtnTitle">ì ìš© ê°€ëŠ¥ ì¿ í°
                                                            ë¦¬ìŠ¤íŠ¸</h5>
                                                        <button type="button" class="close" data-dismiss="modal"
                                                                aria-label="Close">
                                                            <span aria-hidden="true">&times;</span>
                                                        </button>
                                                    </div>
                                                    <div class="modal-body">
                                                        <table class="table" id="couponTable">
                                                            <thead>
                                                            <tr>
                                                                <th scope="col"></th>
                                                                <th scope="col">ì¿ í°ëª…</th>
                                                                <th scope="col">í• ì¸ìœ¨</th>
                                                                <th scope="col">í• ì¸ê¸ˆì•¡</th>
                                                            </tr>
                                                            </thead>
                                                            <tbody>
                                                            <tr>
                                                                <td>
                                                                    <input type="radio"
                                                                           name="coupon" value="1">
                                                                </td>
                                                                <td>íšŒì›ê°€ì… ì¶•í•˜ ì¿ í°</td>
                                                                <td>10%</td>
                                                                <td style="color: dodgerblue">760ì›</td>
                                                            </tr>
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                    <div class="modal-footer">
                                                        <button type="button" class="btn btn-secondary"
                                                                data-dismiss="modal">ì·¨ì†Œ
                                                        </button>
                                                        <button type="button" class="btn btn-dark">ì¿ í° ì„ íƒ</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="column-6">7600 ì›</td>
                                    <td class="column-7">
                                        <select class="packaging form-control form-control-sm">
                                            <option selected value="0">ì„ íƒ X</option>
                                            <option th:if="${bookSale.bookPackaging}"
                                                    th:each="packaging : ${policyList.getPackagingPolicies()}"
                                                    th:value="${packaging.packagingId}"
                                                    th:text="${packaging.packagingType} + ' / ' + ${packaging.packagingPrice} + 'ì›'">
                                            </option>
                                        </select>
                                    </td>
                                </tr>
                            </table>
                        </div>

                        <div class="flex-w flex-sb-m bor15 p-t-18 p-b-15 p-lr-40 p-lr-15-sm">
                            <p class="stext-111 p-t-2" style="color: #760c0c;">
                                íšŒì› - ì¿ í°ì„ ì‚¬ìš©í•˜ì—¬ êµ¬ë§¤í•  ê²½ìš° í™˜ë¶ˆí•  ë•Œ ì¿ í°ì€ í™˜ë¶ˆë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. <br/>
                                ë¹„íšŒì› - ë¹„íšŒì›ì€ ì¿ í°ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
                            </p>
                        </div>

                        <div class="flex-w flex-sb-m bor15 p-t-18 p-b-15 p-lr-40 p-lr-15-sm">

                            <h4>ì£¼ë¬¸ì ì •ë³´</h4>

                            <input type="text" class="stext-104 cl2 plh4 size-116 bor13 p-lr-20 m-r-10 m-tb-5"
                                   placeholder="ì£¼ë¬¸ì ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”." name="saleOrderName"
                                   aria-placeholder="ì£¼ë¬¸ì ì´ë¦„" aria-label="ì£¼ë¬¸ì ì´ë¦„">

                            <input type="text" class="stext-104 cl2 plh4 size-116 bor13 p-lr-20 m-r-10 m-tb-5"
                                   placeholder="ì—°ë½ì²˜ë¥¼ '-'ë¥¼ ì œì™¸í•˜ê³  ì…ë ¥í•´ì£¼ì„¸ìš”." name="saleOrderContact"
                                   aria-placeholder="ì£¼ë¬¸ì ì—°ë½ì²˜" aria-label="ì£¼ë¬¸ì ì—°ë½ì²˜">

                        </div>

                        <div class="flex-w flex-sb-m bor15 p-t-18 p-b-15 p-lr-40 p-lr-15-sm">

                            <h4>ìˆ˜ë ¹ì ì •ë³´</h4>

                            <input type="text" class="stext-104 cl2 plh4 size-116 bor13 p-lr-20 m-r-10 m-tb-5"
                                   placeholder="ìˆ˜ë ¹ì ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”." name="saleReceiverName"
                                   aria-placeholder="ìˆ˜ë ¹ì ì´ë¦„" aria-label="ìˆ˜ë ¹ì ì´ë¦„">

                            <input type="text" class="stext-104 cl2 plh4 size-116 bor13 p-lr-20 m-r-10 m-tb-5"
                                   placeholder="ì—°ë½ì²˜ë¥¼ '-'ë¥¼ ì œì™¸í•˜ê³  ì…ë ¥í•´ì£¼ì„¸ìš”." name="saleReceiverContact"
                                   aria-placeholder="ìˆ˜ë ¹ì ì—°ë½ì²˜" aria-label="ìˆ˜ë ¹ì ì—°ë½ì²˜">
                        </div>

                        <div class="flex-w flex-sb-m bor15 p-t-18 p-b-15 p-lr-40 p-lr-15-sm">

                            <h4>ë°°ì†¡ ì˜ˆì•½ì¼</h4>
                            <span class="stext-111 cl6 p-t-2"> ì˜ˆì•½ì¼ì„ ì§€ì •í•˜ì§€ ì•Šìœ¼ë©´ 2ì¼ ë’¤ë¡œ ì§€ì •ë©ë‹ˆë‹¤. </span>

                            <input type="date" class="stext-104 cl2 plh4 size-115 bor13 p-lr-20 m-r-10 m-tb-"
                                   name="saleDeliveryDate" id="saleDeliveryDate" aria-label="ë°°ì†¡ ì˜ˆì•½ì¼">
                        </div>
                    </div>
                </div>


                <div class="col-sm-10 col-lg-7 col-xl-5 m-lr-auto m-b-50">
                    <div class="bor10 p-lr-40 p-t-30 p-b-40 m-l-63 m-r-40 m-lr-0-xl p-lr-15-sm">
                        <h4 class="mtext-109 cl2 p-b-30">
                            ğŸ“¦ Order Checkout
                        </h4>

                        <div class="flex-w flex-t bor12 p-t-15 p-b-30">
                            <div class="size-208 w-full-ssm">
								<span class="stext-110 cl2">
									ë°°ì†¡ ì •ë³´
								</span>
                            </div>

                            <div class="size-209 p-r-18 p-r-0-sm w-full-ssm">
                                <p class="stext-111 cl6 p-t-2">
                                    ë°°ì†¡ë°›ìœ¼ì‹¤ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.
                                </p>

                                <div class="p-t-15">

                                    <div class="bor8 bg0 m-b-12">
                                        <input class="stext-111 cl8 plh3 size-111 p-lr-15" type="text" name="postcode"
                                               id="postcode" placeholder="ìš°í¸ë²ˆí˜¸">
                                    </div>

                                    <div class="bor8 bg0 m-b-12">
                                        <input class="stext-111 cl8 plh3 size-111 p-lr-15" type="text" name="address"
                                               id="address" placeholder="ë„ë¡œëª…/ì§€ë²ˆ ì£¼ì†Œ">
                                    </div>

                                    <div class="bor8 bg0 m-b-12">
                                        <input class="stext-111 cl8 plh3 size-111 p-lr-15" type="text"
                                               name="detailAddress" id="detailAddress"
                                               placeholder="ìƒì„¸ ì£¼ì†Œ">
                                    </div>

                                    <div class="bor8 bg0 m-b-22">
                                        <input class="stext-111 cl8 plh3 size-111 p-lr-15" type="text"
                                               name="detailAddress" id="extraAddress"
                                               placeholder="ì°¸ê³  í•­ëª© (ì„ íƒ)">
                                    </div>

                                    <div class="flex-w">
                                        <input type="button"
                                               class="flex-c-m stext-101 cl2 size-115 bg8 bor13 hov-btn3 p-lr-15 trans-04 pointer"
                                               value="ì£¼ì†Œ ì°¾ê¸°" onclick="execDaumPostcode()">
                                    </div>

                                </div>
                            </div>
                        </div>


                        <div class="flex-w flex-t p-t-27 p-b-10">
                            <div class="size-208">
                                <span class="mtext-101 cl2">
                                    ë°°ì†¡ë¹„:
                                </span>
                            </div>

                            <div class="size-209 p-t-1">
								<span class="mtext-110 cl2">
									<span id="deliveryPrice"
                                          th:text="${policyList.getDeliveryPolicy().deliveryPolicyFee}"></span>ì›
								</span>
                            </div>
                        </div>

                        <div class="flex-w flex-t p-t-10 p-b-10">
                            <div class="size-208">
                                <span class="mtext-101 cl2">
                                    ì¿ í° í• ì¸:
                                </span>
                            </div>

                            <div class="size-209 p-t-1">
                                <span class="mtext-110 cl2">
									<span id="couponDiscount">0</span>ì›
								</span>
                            </div>

                        </div>

                        <div class="flex-w flex-t p-t-10 p-b-33">
                            <div class="size-208">
								<span class="mtext-101 cl2">
									ê²°ì œí•  ê¸ˆì•¡:
								</span>
                            </div>

                            <div class="size-209 p-t-1">
								<span class="mtext-110 cl2">
									<span id="totalPrice">0</span>ì›
								</span>
                            </div>
                        </div>


                        <button class="flex-c-m stext-101 cl0 size-116 bg3 bor14 hov-btn3 p-lr-15 trans-04 pointer">
                            ğŸ§™ğŸ»â€ ì£¼ë¬¸í•˜ê¸°
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </form>

    <!-- Daum ì£¼ì†Œ -->
    <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    <script src="/js/address.js"></script>
    <script>

        // í˜„ì¬ ë‚ ì§œ ê¸°ì¤€ìœ¼ë¡œ 2ì¼ì„ ë”í•œ ë‚ ì§œë¥¼ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
        function getDefaultDeliveryDate() {
            var today = new Date();
            var deliveryDate = new Date(today);

            // ìµœì†Œ ì˜ˆì•½ ë°°ì†¡ì¼ìëŠ” í˜„ì¬ ë‚ ì§œ + 2ì¼
            deliveryDate.setDate(deliveryDate.getDate() + 2);

            var dd = deliveryDate.getDate();
            var mm = deliveryDate.getMonth() + 1;
            var yyyy = deliveryDate.getFullYear();

            if (dd < 10) {
                dd = '0' + dd;
            }

            if (mm < 10) {
                mm = '0' + mm;
            }

            return yyyy + '-' + mm + '-' + dd;
        }

        function getMaxDeliveryDate() {
            var today = new Date();
            var deliveryDate = new Date(today);

            // ìµœëŒ€ ì˜ˆì•½ ë°°ì†¡ì¼ìëŠ” í˜„ì¬ ë‚ ì§œ + 59ì¼
            deliveryDate.setDate(deliveryDate.getDate() + 59);

            var dd = deliveryDate.getDate();
            var mm = deliveryDate.getMonth() + 1;
            var yyyy = deliveryDate.getFullYear();

            if (dd < 10) {
                dd = '0' + dd;
            }

            if (mm < 10) {
                mm = '0' + mm;
            }

            return yyyy + '-' + mm + '-' + dd;
        }


        // ë°°ì†¡ ë‚ ì§œ input ìš”ì†Œì˜ ìµœì†Œ, ìµœëŒ€ ë‚ ì§œë¥¼ ì„¤ì •í•˜ëŠ” í•¨ìˆ˜
        function setMinDeliveryDate() {
            var deliveryDateInput = document.getElementById('saleDeliveryDate');
            if (deliveryDateInput) {
                deliveryDateInput.value = getDefaultDeliveryDate();
                deliveryDateInput.min = getDefaultDeliveryDate();
                deliveryDateInput.max = getMaxDeliveryDate();
            }
        }


        // ë¬¸ì„œê°€ ë¡œë“œë˜ë©´ ìµœì†Œ ë°°ì†¡ ë‚ ì§œë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
        window.onload = function () {
            setMinDeliveryDate();
        };


    </script>

    <script th:inline="javascript">
        /*<![CDATA[*/
        let packagingPrices = new Map();
        packagingPrices.set(0, 0);
        /*[# th:each="packaging : ${policyList.getPackagingPolicies()}"]*/
        packagingPrices.set([[${packaging.packagingId}]], [[${packaging.packagingPrice}]]);
        /*[/]*/
        /*]]>*/

        let prevPackagingId = 0; // ì´ì „ í¬ì¥ì§€ì˜ IDë¥¼ ì €ì¥í•  ë³€ìˆ˜

        let totalPrice = 0;
        const selectedPackagingId = document.querySelectorAll('select.packaging');
        console.log(selectedPackagingId);

        // ì´ˆê¸° totalPrice ê³„ì‚°
        selectedPackagingId.forEach(selectElement => {
            totalPrice += packagingPrices.get(parseInt(selectElement.value));
        });

        selectedPackagingId.forEach(selectElement => {
            selectElement.addEventListener('change', function (event) {
                // ë³€ê²½ë  ë•Œë§ˆë‹¤ totalPrice ì´ˆê¸°í™”
                totalPrice = 0;
                // ë³€ê²½ëœ ê° ìš”ì†Œì˜ ê°’ì„ totalPriceì— ë”í•¨
                selectedPackagingId.forEach(selectElement => {
                    totalPrice += packagingPrices.get(parseInt(selectElement.value));
                });
                updateTotalPrice(totalPrice);
            });
        });


        // í¬ì¥ì§€ ì„ íƒ ì‹œ total ê¸ˆì•¡ì„ ì—…ë°ì´íŠ¸í•˜ëŠ” í•¨ìˆ˜
        function updateTotalPrice(totalPrice) {
            console.log('total : ' + totalPrice);
            let totalPriceElement = document.getElementById('totalPrice');
            totalPriceElement.textContent = totalPrice.toFixed(0);

        }
    </script>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="/js/coupon.js"></script>

</div>

</html>